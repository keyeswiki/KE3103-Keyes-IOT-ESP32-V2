### ç¬¬22è¯¾ WiFi+ç½‘é¡µ æ§åˆ¶æ™ºèƒ½å®¶å±…

#### 22.1 é¡¹ç›®ä»‹ç»

å¤§éƒ¨åˆ†äººéƒ½æœ‰æ‰‹æœºï¼Œç°åœ¨å¤§éƒ¨åˆ†ç‰©è”ç½‘äº§å“çš„æ§åˆ¶ç«¯éƒ½æ˜¯ç”¨æ‰‹æœºï¼Œä½¿ç”¨èµ·æ¥å°±å¾ˆä¾¿æ·ï¼Œæ‰“å¼€æ‰‹æœºAPPï¼Œç‚¹å‡»ä¸€ä¸‹å°±èƒ½å¯åŠ¨å„ç§è®¾å¤‡ã€‚

æœ¬æ•™ç¨‹å°†ä¸ºæ‚¨è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ESP32å¼€å‘æ¿å®ç°WIFIç½‘é¡µæ§åˆ¶æ™ºèƒ½å®¶å±…ç³»ç»Ÿï¼Œç³»ç»ŸåŒ…æ‹¬XHT11æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ã€äººä½“çº¢å¤–çƒ­é‡Šç”µä¼ æ„Ÿå™¨ã€MQ2æ°”ä½“ä¼ æ„Ÿå™¨ã€æ°´æ»´ä¼ æ„Ÿå™¨ç»§ç”µå™¨ã€é»„è‰²LEDæ¨¡å—ã€130ç”µæœº(é£æ‰‡)æ¨¡å—ã€é—¨èˆµæœºã€çª—æˆ·èˆµæœºå’ŒSK6812RGBç¯æ¨¡å— ç­‰ä¼ æ„Ÿå™¨æ¨¡å—ã€‚

æ•™ç¨‹å†…å®¹åŒ…æ‹¬ESP32çš„WiFié…ç½®ã€ç½‘é¡µè®¾ç½®ä»¥åŠå¦‚ä½•ç¼–å†™ä»£ç ç­‰å®ç°è¿œç¨‹ç›‘æ§å’Œæ§åˆ¶ã€‚æ‚¨å°†å­¦ä¹ å¦‚ä½•å°†ESP32è¿æ¥åˆ°WIFIç½‘é¡µæœåŠ¡å™¨ï¼Œå¹¶é€šè¿‡å‘å¸ƒå’Œè®¢é˜…æ¶ˆæ¯æ¥è¯»å–æ¸©æ¹¿åº¦ã€é›¨æ°´é‡ã€å¯ç‡ƒæ€§æ°”ä½“æ˜¯å¦æº¢å‡ºå’Œäººä½“æ£€æµ‹ç­‰ç›¸å…³æ•°æ®ï¼Œå¹¶æ ¹æ®éœ€è¦æ§åˆ¶LEDã€é£æ‰‡ã€é—¨èˆµæœºã€çª—æˆ·èˆµæœºå’ŒSK6812RGBç¯ç­‰çŠ¶æ€ã€‚æ­¤å¤–ï¼Œæ— è®ºæ‚¨æ˜¯ç‰©è”ç½‘åˆå­¦è€…è¿˜æ˜¯æœ‰ç»éªŒçš„å¼€å‘è€…ï¼Œæœ¬æ•™ç¨‹éƒ½å°†å¸®åŠ©æ‚¨æŒæ¡ESP32åŸºäºWiFiç½‘é¡µçš„è¿œç¨‹ç›‘æµ‹ä¸æ§åˆ¶ç³»ç»Ÿå¼€å‘ï¼Œä¸ºæ‚¨çš„é¡¹ç›®å¢æ·»æ™ºèƒ½çš„å®¶å±…ç®¡ç†åŠŸèƒ½ã€‚

#### 22.2 å®éªŒç»„ä»¶

|![](media/esp32.png)|![](media/xht11.png)|![](media/yellow-led2.png)|![](media/SK6812RGB.png)|
|-|-|-|-|
|ESP32 Plusä¸»æ¿ *1|XHT11ä¼ æ„Ÿå™¨ *1|é»„è‰²LEDæ¨¡å— *1|SK6812RGBç¯æ¨¡å— *1|
|![](media/pir.png)|![](media/motor.png)|![](media/servo.png)|![](media/stem.png)|
|äººä½“çº¢å¤–çƒ­é‡Šä¼ æ„Ÿå™¨ *1|130ç”µæœºæ¨¡å— *1|180åº¦èˆµæœº *2|æ°´æ»´ä¼ æ„Ÿå™¨æ¨¡å— *1|
|![](media/gas.png)|![](media/fan2.png)|![](media/lcd2.png)|![](media/usb.png)|
|MQ2ä¼ æ„Ÿå™¨ *1|é£æ‰‡å¶ *1|I2C LCD1602æ¨¡å— * 1|USBçº¿ *1|
|![](media/4p.png)|![](media/3p.png)| | |
|4Pçº¿ *3|3Pçº¿ *5| | |

#### 22.3 æ¨¡å—æ¥çº¿å›¾ 

âš ï¸ **ç‰¹åˆ«æ³¨æ„ï¼šæ™ºèƒ½å®¶å±…å·²ç»ç»„è£…å¥½äº†ï¼Œè¿™é‡Œä¸éœ€è¦æŠŠæ‰€æœ‰çš„ä¼ æ„Ÿå™¨/æ¨¡å—æ‹†ä¸‹æ¥åˆé‡æ–°ç»„è£…å’Œæ¥çº¿ï¼Œè¿™é‡Œå†æ¬¡æä¾›æ¥çº¿å›¾ï¼Œæ˜¯ä¸ºäº†æ–¹ä¾¿æ‚¨ç¼–å†™ä»£ç ï¼**

|ä¼ æ„Ÿå™¨æ¨¡å—åç§°|ä¼ æ„Ÿå™¨æ¨¡å—å¼•è„š|ESP32 Plusä¸»æ¿å¯¹åº”çš„æ¥çº¿|
|-|-|-|
|äººä½“çº¢å¤–çƒ­é‡Šä¼ æ„Ÿå™¨æ¨¡å—|G/V/S|G/V/io14|
|é»„è‰²LEDæ¨¡å—|G/V/S|G/V/io12|
|ç”µæœºæ¨¡å—|GND/VCC/IN+/IN-|G/V/io19/io18|
|æ§åˆ¶é—¨çš„èˆµæœº1|æ£•è‰²çº¿/çº¢è‰²çº¿/æ©™è‰²çº¿|G/V/io13|
|æ§åˆ¶çª—çš„èˆµæœº2|æ£•è‰²çº¿/çº¢è‰²çº¿/æ©™è‰²çº¿|G/V/io5|
|MQ-2æ°”ä½“ä¼ æ„Ÿå™¨æ¨¡å—|GND/VCC/D|G/V/io23|
|XHT11æ¨¡å—|G/V/S|G/V/io17|
|SK6812RGBç¯æ¨¡å—|G/V/S|G/V/io26|
|LCD1602æ˜¾ç¤ºå±æ¨¡å—|GND/VCC/SDA/SCL|GND/V/SDA/SCL|
|æ°´æ»´ä¼ æ„Ÿå™¨æ¨¡å—|G/V/S|G/V/io34|

#### 22.4 ä»£ç æµç¨‹å›¾

![](media/project22.png) 

#### 22.5 WiFiç½‘é¡µæ§åˆ¶æ™ºèƒ½å®¶å±…çš„å®éªŒä»£ç  

æ‰“å¼€â€œThonnyâ€è½¯ä»¶ï¼Œç‚¹å‡»â€œæ­¤ç”µè„‘â€ â†’ â€œD:â€ â†’ â€œPythonèµ„æ–™â€ â†’ â€œPython_ä»£ç â€ã€‚å¹¶é¼ æ ‡å·¦é”®åŒå‡» â€œProject22.2_wifi_control_smart_home.pyâ€ã€‚

âš ï¸ <span style="color: rgb(255, 76, 65);">**ç‰¹åˆ«æé†’ï¼š**</span> æ‰“å¼€ä»£ç æ–‡ä»¶åï¼Œéœ€è¦ä¿®æ”¹ESP32å¼€å‘æ¿éœ€è¦è¿æ¥çš„WiFiåç§°ä¸å¯†ç ï¼Œæ‚¨éœ€è¦åˆ†åˆ«å°† `ChinaNet-2.4G-0DF0` å’Œ `ChinaNet@233` æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ Wi-Fi åç§°å’Œ WiFi å¯†ç ã€‚WiFiåç§°å’ŒWiFiå¯†ç ä¿®æ”¹åæ‰èƒ½ä¸Šä¼ ä»£ç ï¼Œå¦åˆ™ä½ çš„ESP32å¼€å‘æ¿å°†æ— æ³•è¿æ¥ç½‘ç»œã€‚

```python
SSID = "ChinaNet-2.4G-0DF0"   # æ›¿æ¢ä¸ºä½ çš„Wi-Fiåç§°
PASSWORD = "ChinaNet@233"   # æ›¿æ¢ä¸ºä½ çš„Wi-Fiå¯†ç  
```

âš ï¸ **<span style="color: rgb(255, 76, 65);">æ³¨æ„ï¼š</span> è¯·ç¡®ä¿ä»£ç ä¸­çš„WiFiåç§°å’ŒWiFiå¯†ç ä¸è¿æ¥åˆ°æ‚¨çš„è®¡ç®—æœºã€æ‰‹æœº/å¹³æ¿ç”µè„‘ã€ESP32å¼€å‘æ¿å’Œè·¯ç”±å™¨çš„ç½‘ç»œç›¸åŒï¼Œå®ƒä»¬å¿…é¡»åœ¨åŒä¸€å±€åŸŸç½‘ï¼ˆWiFiï¼‰å†…ã€‚**

âš ï¸ **<span style="color: rgb(255, 76, 65);">æ³¨æ„ï¼š</span>WiFiå¿…é¡»æ˜¯2.4Ghzé¢‘ç‡çš„ï¼Œå¦åˆ™ESP32æ— æ³•è¿æ¥WiFiï¼Œä¸æ”¯æŒè¿æ¥5GHzé¢‘æ®µçš„WiFiã€‚**ã€‚

```python
# ä½œè€… : www.keyes-robot.com

from machine import Pin, ADC, PWM, I2C
from time import sleep_ms, ticks_ms  
from i2c_lcd import I2cLcd   
import network
import socket 
import time
import json
from neopixel import NeoPixel
import dht

# WiFié…ç½®, ç›®çš„æ˜¯è¿æ¥Wi-Fi
SSID = "ChinaNet-2.4G-0DF0"   # æ›¿æ¢ä¸ºä½ çš„Wi-Fiåç§°
PASSWORD = "ChinaNet@233"   # æ›¿æ¢ä¸ºä½ çš„Wi-Fiå¯†ç   

# å®šä¹‰ä¼ æ„Ÿå™¨æ¨¡å—å¼•è„š
LED_PIN = 26
LED_COUNT = 4
WATER_PIN = 34
FAN_PIN1 = 19
FAN_PIN2 = 18
LED_Y_PIN = 12
GAS_PIN = 23
PYROELECTRIC_PIN = 14
DHT11_PIN = 17
SERVO_PIN1 = 5
SERVO_PIN2 = 13 

# åˆå§‹åŒ–è®¾å¤‡
led_y = Pin(LED_Y_PIN, Pin.OUT)
fan_pin1 = Pin(FAN_PIN1, Pin.OUT)
fan_pin2 = Pin(FAN_PIN2, Pin.OUT)
water_sensor = ADC(Pin(WATER_PIN))
water_sensor.atten(ADC.ATTN_11DB)
gas_sensor = Pin(GAS_PIN, Pin.IN)
pir_sensor = Pin(PYROELECTRIC_PIN, Pin.IN)
dht_sensor = dht.DHT11(Pin(DHT11_PIN))

# è°ƒè¯•ç‰ˆèˆµæœºæ§åˆ¶ç±»
class DebugServo:
    def __init__(self, pin, name="Servo", open_duty=115, close_duty=25):
        self.name = name
        self.pin = pin
        self.servo = PWM(Pin(pin))
        self.servo.freq(50)  # å¿…é¡»ä¸º50Hz
        self.open_duty = open_duty
        self.close_duty = close_duty
        self.current_duty = close_duty
        self.is_open = False
        
        # æµ‹è¯•PWMè¾“å‡º
        print(f"=== {self.name} Initialization ===")
        print(f"Pin: {pin}, Open: {open_duty}, Close: {close_duty}")
        
        # åˆå§‹åŒ–ä¸ºå…³é—­ä½ç½®
        self.servo.duty(close_duty)
        print(f"{self.name} initialized to CLOSE position (duty: {close_duty})")
        sleep_ms(1000)
    
    def open(self):
        """æ‰“å¼€èˆµæœº"""
        print(f"ğŸ¯ {self.name} OPENING to duty: {self.open_duty}")
        try:
            self.servo.duty(self.open_duty)
            self.current_duty = self.open_duty
            self.is_open = True
            sleep_ms(800)  # ç»™èˆµæœºè¶³å¤Ÿæ—¶é—´ç§»åŠ¨
            print(f"âœ… {self.name} OPENED successfully")
            return True
        except Exception as e:
            print(f"âŒ {self.name} OPEN failed: {e}")
            return False
    
    def close(self):
        """å…³é—­èˆµæœº"""
        print(f"ğŸ¯ {self.name} CLOSING to duty: {self.close_duty}")
        try:
            self.servo.duty(self.close_duty)
            self.current_duty = self.close_duty
            self.is_open = False
            sleep_ms(800)  # ç»™èˆµæœºè¶³å¤Ÿæ—¶é—´ç§»åŠ¨
            print(f"âœ… {self.name} CLOSED successfully")
            return True
        except Exception as e:
            print(f"âŒ {self.name} CLOSE failed: {e}")
            return False
    
    def get_status(self):
        """è·å–çŠ¶æ€"""
        return f"{self.name}: {'OPEN' if self.is_open else 'CLOSED'} (duty: {self.current_duty})"

# åˆå§‹åŒ–èˆµæœº - å°è¯•ä¸åŒçš„å ç©ºæ¯”å€¼
print("=== INITIALIZING SERVOS ===")
servo1 = DebugServo(SERVO_PIN1, "Window Servo", open_duty=80, close_duty=25)
servo2 = DebugServo(SERVO_PIN2, "Door Servo", open_duty=115, close_duty=25)

# æµ‹è¯•èˆµæœº
print("=== TESTING SERVOS ===")
servo1.close()
servo2.close()
sleep_ms(1000)

# åˆå§‹åŒ–NeoPixel
strip = NeoPixel(Pin(LED_PIN), LED_COUNT)

# åˆå§‹åŒ–LCD
DEFAULT_I2C_ADDR = 0x27
i2c = I2C(scl=Pin(22), sda=Pin(21), freq=400000) 
lcd = I2cLcd(i2c, DEFAULT_I2C_ADDR, 2, 16)

# ä¼ æ„Ÿå™¨æ•°æ®å˜é‡
rainwater = 0
gas = 0
pir = 0
temperature = 0
humidity = 0

# è¿æ¥WiFiï¼Œè·å–IPåœ°å€
def connect_wifi():
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    wlan.connect(SSID, PASSWORD)
    
    print("Connecting to WiFi...", end="")
    while not wlan.isconnected():
        print(".", end="")
        time.sleep(1)
    
    print("\nConnected to WiFi")
    print("WiFi NAME:", SSID)
    print("IP:", wlan.ifconfig()[0])
    return wlan.ifconfig()[0]

# è¯»å–ä¼ æ„Ÿå™¨çš„æ•°æ®
def get_sensors_data():
    global rainwater, gas, pir, temperature, humidity
    
    try:
        dht_sensor.measure()
        temperature = dht_sensor.temperature()
        humidity = dht_sensor.humidity()
    except:
        temperature = 0
        humidity = 0
    
    rainwater = water_sensor.read()
    gas = gas_sensor.value()
    pir = pir_sensor.value()
    
# SK6812RGBç¯ç›¸å…³å‡½æ•°
def color_wipe(color, wait):
    for i in range(LED_COUNT):
        strip[i] = color
        strip.write()
        time.sleep_ms(wait)

def rainbow(wait):
    for j in range(256):
        for i in range(LED_COUNT):
            strip[i] = wheel((i + j) & 255)
        strip.write()
        time.sleep_ms(wait)
        
def wheel(pos):
    if pos < 85:
        return (pos * 3, 255 - pos * 3, 0)
    elif pos < 170:
        pos -= 85
        return (255 - pos * 3, 0, pos * 3)
    else:
        pos -= 170 
        return (0, pos * 3, 255 - pos * 3)
    
def theater_chase_rainbow(wait):
    first_pixel_hue = 0
    for a in range(30):
        for b in range(3):
            strip.fill((0, 0, 0))
            for c in range(b, len(strip), 3):
                hue = first_pixel_hue + c * 65536 // len(strip)
                rgb = hsv_to_rgb(hue / 65536.0, 1.0, 1.0)
                strip[c] = (int(rgb[0]), int(rgb[1]), int(rgb[2]))
            strip.write()
            time.sleep_ms(wait)
            first_pixel_hue += 65536 // 90

def hsv_to_rgb(h, s, v):
    if s == 0.0:
        return (v * 255, v * 255, v * 255)
    i = int(h * 6.0)
    f = (h * 6.0) - i
    p = v * (1.0 - s)
    q = v * (1.0 - s * f)
    t = v * (1.0 - s * (1.0 - f))
    i = i % 6
    if i == 0:
        return (v * 255, t * 255, p * 255)
    if i == 1:
        return (q * 255, v * 255, p * 255)
    if i == 2:
        return (p * 255, v * 255, t * 255)
    if i == 3:
        return (p * 255, q * 255, v * 255)
    if i == 4:
        return (t * 255, p * 255, v * 255)
    if i == 5:
        return (v * 255, p * 255, q * 255)

# å‘é€HTMLé¡µé¢, å‘é€ä¼ æ„Ÿå™¨æ•°æ®, å¤„ç†æ§åˆ¶è¯·æ±‚
def handle_request(client, request):
    get_sensors_data()
    
    if "GET / " in request:
        # å‘é€HTMLé¡µé¢
        html = create_html_page()
        client.send(html)
    
    elif "GET /data" in request:
        # å‘é€ä¼ æ„Ÿå™¨æ•°æ®
        data = f"{rainwater},{gas},{pir},{temperature},{humidity}"
        client.send(f"HTTP/1.1 200 OK\r\nContent-Type: text/plain\r\n\r\n{data}")
    
    elif "GET /control" in request:       
        response = "OK"
        
        # å¤„ç†æ§åˆ¶è¯·æ±‚ - æ·»åŠ è¯¦ç»†è°ƒè¯•
        if "?cmd=e" in request:
            print("\n" + "="*50)
            print("ğŸšª DOOR OPEN COMMAND RECEIVED")
            servo2.open()  # å¼€é—¨ 
            print(f"Door status: {servo2.get_status()}")
            
        elif "?cmd=E" in request:
            print("\n" + "="*50)
            print("ğŸšª DOOR CLOSE COMMAND RECEIVED")
            servo2.close()  # å…³é—¨ 
            print(f"Door status: {servo2.get_status()}")
            
        elif "?cmd=a" in request:
            led_y.on()   # ç‚¹äº®é»„è‰²LED 
            print("Yellow LED ON")
            
        elif "?cmd=A" in request:
            led_y.off()  # å…³é—­é»„è‰²LED
            print("Yellow LED OFF")
            
        elif "?cmd=b" in request:
            print("\n" + "="*50)
            print("ğŸªŸ WINDOW OPEN COMMAND RECEIVED")
            servo1.open()  # å¼€çª—
            print(f"Window status: {servo1.get_status()}")
            
        elif "?cmd=B" in request:
            print("\n" + "="*50)
            print("ğŸªŸ WINDOW CLOSE COMMAND RECEIVED")
            servo1.close()  # å…³çª—
            print(f"Window status: {servo1.get_status()}")
            
        elif "?cmd=f" in request:
            fan_pin2.off() 
            fan_pin1.on()  # å¼€å¯é£æ‰‡
            print("Fan ON")
            
        elif "?cmd=F" in request:
            fan_pin2.off()
            fan_pin1.off()  # å…³é—­é£æ‰‡
            print("Fan OFF")
        
        # RGB LEDæ§åˆ¶
        elif "?cmd=g" in request:
            color_wipe((255, 0, 0), 50)  # RGBäº®çº¢ç¯
            print("Red on")
        elif "?cmd=G" in request:
            color_wipe((0, 0, 0), 50)   # RGBç†„ç­
            print("RGB off")
        elif "?cmd=h" in request:
            color_wipe((200, 100, 0), 50)  # RGBäº®æ©™ç¯
            print("Orange on")
        elif "?cmd=H" in request:
            color_wipe((0, 0, 0), 50)
            print("RGB off")
        elif "?cmd=i" in request:
            color_wipe((200, 200, 0), 50)  # RGBäº®é»„ç¯
            print("Yellow on")
        elif "?cmd=I" in request:
            color_wipe((0, 0, 0), 50)
            print("RGB off")
        elif "?cmd=j" in request:
            color_wipe((0, 255, 0), 50)  # RGBäº®ç»¿ç¯
            print("Green on")
        elif "?cmd=J" in request:
            color_wipe((0, 0, 0), 50)
            print("RGB off")
        elif "?cmd=k" in request:
            color_wipe((0, 100, 255), 50)  # RGBäº®è“ç»¿ç¯
            print("Green-blue on")
        elif "?cmd=K" in request:
            color_wipe((0, 0, 0), 50)
            print("RGB off")
        elif "?cmd=l" in request:
            color_wipe((0, 0, 255), 50)  # RGBäº®è“ç¯
            print("Blue on")
        elif "?cmd=L" in request:
            color_wipe((0, 0, 0), 50)
            print("RGB off")
        elif "?cmd=m" in request:
            color_wipe((100, 0, 255), 50)  # RGBäº®ç´«ç¯
            print("Purple on")
        elif "?cmd=M" in request:
            color_wipe((0, 0, 0), 50)
            print("RGB off")
        elif "?cmd=n" in request:
            color_wipe((255, 255, 255), 50)  # RGBäº®ç™½ç¯
            print("White on")
        elif "?cmd=N" in request:
            color_wipe((0, 0, 0), 50)
            print("RGB off")
        elif "?cmd=o" in request:
            rainbow(10)   # RGBäº®å½©è™¹ç¯
            print("Rainbow on")
        elif "?cmd=O" in request:
            color_wipe((0, 0, 0), 50)
            print("RGB off")
        elif "?cmd=p" in request:
            theater_chase_rainbow(50)  # RGBå®ç°è·‘ç¯æ•ˆæœ
            print("Chase on")
        elif "?cmd=P" in request:
            color_wipe((0, 0, 0), 50)
            print("RGB off")
        
        client.send("HTTP/1.1 200 OK\r\n\r\nOK")

# ç½‘é¡µé¡µé¢
def create_html_page():
    html = """HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n
    <!DOCTYPE html>
    <html>
    <head>
        <title>ESP32 Smart Home</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            body { font-family: Arial; margin: 20px; background: #f0f0f0; }
            .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
            .sensor-data { background: #e8f4fd; padding: 15px; border-radius: 5px; margin: 10px 0; }
            .control-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 20px 0; }
            .btn { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
            .btn-on { background: #4CAF50; color: white; }
            .btn-off { background: #f44336; color: white; }
            .btn-special { background: #2196F3; color: white; }
            .data-value { font-weight: bold; color: #2196F3; }
        </style>
        <script>
            function updateData() {
                fetch('/data')
                    .then(response => response.text())
                    .then(data => {
                        const values = data.split(',');
                        document.getElementById('rainwater').textContent = values[0];
                        document.getElementById('gas').textContent = values[1];
                        document.getElementById('pir').textContent = values[2];
                        document.getElementById('temp').textContent = values[3];
                        document.getElementById('humi').textContent = values[4];
                    });
            }
            
            function sendCommand(cmd) {
                console.log('Sending command:', cmd);
                fetch('/control?cmd=' + cmd)
                    .then(response => {
                        console.log('Command', cmd, 'sent successfully');
                    })
                    .catch(err => {
                        console.error('Command error:', err);
                    }); 
            }
            
            setInterval(updateData, 2000);
            window.onload = updateData;
        </script>
    </head>
    <body>
        <div class="container">
            <h1>ESP32 æ™ºèƒ½å®¶å±…æ§åˆ¶ - DEBUG MODE</h1>
            
            <div class="sensor-data"> 
                <h2>ä¼ æ„Ÿå™¨æ•°æ®</h2>
                <p>æ¸©åº¦: <span id="temp" class="data-value">0</span> Â°C</p>
                <p>æ¹¿åº¦: <span id="humi" class="data-value">0</span> %</p>
                <p>é›¨æ°´é‡: <span id="rainwater" class="data-value">0</span></p>
                <p>äººä½“ç§»åŠ¨æ£€æµ‹: <span id="pir" class="data-value">0</span></p>
                <p>å¯ç‡ƒæ€§æ°”ä½“æ£€æµ‹: <span id="gas" class="data-value">0</span></p>
            </div>
            
            <div class="control-panel">
                <h3>èˆµæœºæ§åˆ¶</h3>
                <button class="btn btn-on" onclick="sendCommand('e')">å¼€é—¨</button>
                <button class="btn btn-off" onclick="sendCommand('E')">å…³é—¨</button>
                <button class="btn btn-on" onclick="sendCommand('b')">å¼€çª—</button>
                <button class="btn btn-off" onclick="sendCommand('B')">å…³çª—</button>
                
                <h3>å…¶ä»–æ§åˆ¶</h3>
                <button class="btn btn-on" onclick="sendCommand('a')">æ‰“å¼€é»„ç¯</button>
                <button class="btn btn-off" onclick="sendCommand('A')">å…³é—­é»„ç¯</button>
                <button class="btn btn-on" onclick="sendCommand('f')">å¼€å¯é£æ‰‡</button>
                <button class="btn btn-off" onclick="sendCommand('F')">å…³é—­é£æ‰‡</button>
            </div>
            
            <div class="control-panel">
                <h4>RGBç¯è‰²</h4>
                <button class="btn" style="background:red;color:white" onclick="sendCommand('g')">çº¢è‰²</button>
                <button class="btn" style="background:orange;color:white" onclick="sendCommand('h')">æ©™è‰²</button>
                <button class="btn" style="background:yellow;color:black" onclick="sendCommand('i')">é»„è‰²</button>
                <button class="btn" style="background:green;color:white" onclick="sendCommand('j')">ç»¿è‰²</button>
                <button class="btn" style="background:cyan;color:white" onclick="sendCommand('k')">è“ç»¿è‰²</button>
                <button class="btn" style="background:blue;color:white" onclick="sendCommand('l')">è“è‰²</button>
                <button class="btn" style="background:purple;color:white" onclick="sendCommand('m')">ç´«è‰²</button>
                <button class="btn" style="background:white;color:black" onclick="sendCommand('n')">ç™½è‰²</button>
                <button class="btn btn-special" onclick="sendCommand('o')">å½©è™¹</button>
                <button class="btn btn-special" onclick="sendCommand('p')">è·‘ç¯</button>
                <button class="btn btn-off" onclick="sendCommand('G')">å…³é—­RGB</button>
            </div>
        </div>
    </body>
    </html>
    """
    return html

def main():
    ip = connect_wifi()
    
    # åœ¨LCDæ˜¾ç¤ºIP
    lcd.move_to(0, 0)
    lcd.putstr('IP:')
    lcd.move_to(0, 1)
    lcd.putstr(ip) 
    
    # åˆ›å»ºsocketæœåŠ¡å™¨
    addr = socket.getaddrinfo('0.0.0.0', 80)[0][-1]
    server = socket.socket()
    server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server.bind(addr)
    server.listen(5)
    
    print("Server listening on", ip)
    print("Ready for commands...")
    
    while True:
        try:
            client, addr = server.accept()
            print(f"\nğŸ“± Client connected from {addr}")
            
            request = client.recv(1024).decode()
            print(f"ğŸ“¨ Request: {request.split()[0]} {request.split()[1]}")
            
            handle_request(client, request)
            
            client.close()
            
        except Exception as e:
            print(f"âŒ Server error: {e}")
            try:
                client.close()
            except:
                pass
            time.sleep(1)

if __name__ == "__main__":
    main()
```
#### 22.6 å®éªŒç»“æœ

âš ï¸ <span style="color: rgb(255, 76, 65);">**æ³¨æ„ï¼šæ‰‹æœº/å¹³æ¿éœ€è¦å’Œæ™ºèƒ½å®¶å±…è¿æ¥åŒä¸€ä¸ªWiFiï¼Œæˆ–è€…æ‰‹æœº/å¹³æ¿æ‰“å¼€çƒ­ç‚¹ï¼Œæ™ºèƒ½å®¶å±…è¿æ¥æ‰‹æœº/å¹³æ¿çš„çƒ­ç‚¹ï¼Œä¸”ç¤ºä¾‹ä»£ç ä¸­çš„WiFiåç§°ä¸WiFiå¯†ç å’Œæ‰‹æœº/å¹³æ¿ã€æ™ºèƒ½å®¶å±…æ˜¯åŒä¸€ä¸ªWiFiåç§°ä¸å¯†ç ã€‚** </span>

âš ï¸ **<span style="color: rgb(255, 76, 65);">æ³¨æ„ï¼š</span>WiFiå¿…é¡»æ˜¯2.4Ghzé¢‘ç‡çš„ï¼Œå¦åˆ™ESP32æ— æ³•è¿æ¥WiFiï¼Œä¸æ”¯æŒè¿æ¥5GHzé¢‘æ®µçš„WiFiã€‚**ã€‚

âš ï¸ **<span style="color: rgb(255, 76, 65);">ç‰¹åˆ«æ³¨æ„ï¼š</span> æ‰‹æœºæˆ–å¹³æ¿ä¸€å®šè¦ä¸ESP32å¼€å‘æ¿è¿æ¥çš„æ˜¯åŒä¸€ä¸ªWiFiï¼Œå¦åˆ™å°†æ— æ³•è¿›å…¥æ§åˆ¶é¡µé¢ã€‚è¿˜æœ‰å°±æ˜¯ESP32å¼€å‘æ¿åœ¨ä½¿ç”¨WiFiåŠŸèƒ½æ—¶åŠŸè€—å¾ˆå¤§ï¼Œéœ€è¦å¤–æ¥DCç”µæº(ç”µæºç”µå‹å¿…é¡»å……è¶³ï¼Œæœ€å¥½ä½¿ç”¨æ–°ç”µæ± )æ‰èƒ½æ»¡è¶³å®ƒçš„å·¥ä½œç”µåŠ›éœ€æ±‚ï¼Œå¦‚æœè¾¾ä¸åˆ°å®ƒçš„å·¥ä½œç”µåŠ›éœ€æ±‚ï¼ŒESP32æ¿å°†ä¼šä¸€ç›´å¤ä½å¯¼è‡´ä»£ç æ— æ³•æ­£å¸¸è¿è¡Œã€‚**

æŒ‰ç…§æ¥çº¿å›¾æ¥å¥½çº¿ï¼Œå°† ESP32 ä¸»æ§æ¿é€šè¿‡Micro USBæ•°æ®çº¿ä¸è®¡ç®—æœºç›¸è¿ä¾›ç”µï¼Œå¤–æ¥ç”µæºä¾›ç”µï¼Œç„¶åå•å‡»æŒ‰é’®![](media/1305.png)ï¼Œç¤ºä¾‹ä»£ç å¼€å§‹æ‰§è¡Œã€‚


![](media/AB1.png)

ç¤ºä¾‹ä»£ç å¼€å§‹æ‰§è¡Œä¹‹åï¼Œä½ ä¼šçœ‹åˆ°çš„ç°è±¡æ˜¯ï¼šShellçª—å£ä¸­ä¼šæ‰“å°å¦‚ä¸‹ç›¸å…³ä¿¡æ¯ã€‚åŒæ—¶ï¼Œå¦‚æœæˆåŠŸè¿æ¥ä¸ŠWiFiï¼ŒShellçª—å£ä¸­è¿˜ä¼šæ‰“å°WiFiåç§°å’Œåˆ†é…åˆ°çš„IPåœ°å€ï¼ˆå‡å¦‚Shellçª—å£ä¸­æ²¡æœ‰æ‰“å°å‡ºåˆ†é…åˆ°çš„IPåœ°å€ï¼Œå¯ä»¥æŒ‰ä¸‹ESP32ä¸»æ§æ¿ä¸Šçš„å¤ä½é”®é‡å¯ï¼Œé‡æ–°è¿æ¥WiFiï¼‰ï¼ŒåŒæ—¶LCD1602æ˜¾ç¤ºå¯¹åº”çš„IPåœ°å€ã€‚ä¸åŒçš„ç½‘ç»œï¼ˆWiFiï¼‰ï¼ŒIPåœ°å€ä¸ä¸€æ ·ã€‚

![](media/QASF12.png)

![](media/CDFxz11.jpg)

ç„¶åï¼Œæ‚¨å¯ä»¥åœ¨æ‰‹æœºç«¯/å¹³æ¿ç«¯çš„æµè§ˆå™¨ä¸­è¾“å…¥ä¸²å£ç›‘è§†å™¨æ‰“å°çš„ ESP32 IPåœ°å€ æˆ– LCDæ˜¾ç¤ºå±æ˜¾ç¤ºçš„ ESP32 IPåœ°å€ï¼Œä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ESP32çš„IPåœ°å€ï¼Œå¹¶è®¿é—®ç½‘é¡µã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæ‚¨å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ä½ è‡ªå·±çš„**ESP32 IPåœ°å€**(**è¿™é‡Œæ˜¯ä»¥192.168.31.131ä¸ºä¾‹ï¼Œè€Œä½ éœ€è¦å°†IPåœ°å€ï¼š192.168.31.131 ä¿®æ”¹æˆä½ è‡ªå·±çš„ ESP32 IPåœ°å€**)ï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ESP32çš„IPåœ°å€æ¥æŸ¥çœ‹ä¼ æ„Ÿå™¨ï¼ˆXHT11æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ã€äººä½“çº¢å¤–çƒ­é‡Šç”µä¼ æ„Ÿå™¨ã€MQ2æ°”ä½“ä¼ æ„Ÿå™¨ã€æ°´æ»´ä¼ æ„Ÿå™¨ç»§ç”µå™¨ï¼‰æ£€æµ‹çš„æ•°æ®ã€èˆµæœºæ§åˆ¶ï¼ˆé—¨èˆµæœºã€çª—æˆ·èˆµæœºï¼‰å’Œé»„è‰²LEDæ¨¡å—æ§åˆ¶ç½‘é¡µã€‚

![](media/WEDazx1.png)

è¿›å…¥å¯¹åº”WiFiç½‘é¡µä¹‹åï¼Œå¯ä»¥çœ‹åˆ°ç½‘é¡µä¸­æ˜¾ç¤º â€œä¼ æ„Ÿå™¨æ•°æ®â€ã€â€œèˆµæœºæ§åˆ¶â€ã€â€œå…¶ä»–æ§åˆ¶â€ã€â€œRGBç¯è‰²â€ ç­‰ç›¸å…³è®¾å¤‡ã€‚

![](media/OLKJD12.jpg)

åŒæ—¶ï¼ŒShellçª—å£ä¸­ä¼šæ‰“å°å¦‚ä¸‹ç›¸å…³ä¿¡æ¯ã€‚

![](media/QQES123.png)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰‹æœº/å¹³æ¿ç­‰è®¾å¤‡çš„WiFiç½‘é¡µæ¥æ“ä½œ â€œESP32æ™ºèƒ½å®¶å±…æ§åˆ¶â€ ç½‘é¡µä¸­çš„ç›¸å…³è®¾å¤‡ã€‚

âš ï¸ **<span style="color: rgb(255, 76, 65);">ç‰¹åˆ«æé†’ï¼š</span> å¦‚æœæœªæ¥å¤–æ¥DCç”µæº(æˆ–è€…å¤–æ¥ç”µæºç”µå‹ä¸è¶³)æ—¶ï¼Œä¼šå‡ºç°å¦‚ä¸‹ç°è±¡ï¼ŒUSBä¸²å£æµå¤±ï¼Œé€€å‡ºç¨‹åºã€‚è¿™æ—¶å€™éœ€è¦é‡æ–°æ›´æ¢æ–°ç”µæ± ï¼Œå¤–æ¥ç”µæºï¼Œé‡æ–°å•å‡»æŒ‰é’®![](media/1305.png)ï¼Œä½¿ç¤ºä¾‹ä»£ç é‡æ–°è¿è¡Œã€‚**

![](media/QQPOL11.png)

âš ï¸ **<span style="color: rgb(255, 76, 65);">ç‰¹åˆ«æ³¨æ„ï¼š</span> ä¸€å®šè¦å¤–æ¥ç”µæºï¼Œå¤–æ¥DCç”µæº (ç”µæºç”µå‹å¿…é¡»å……è¶³ï¼Œæœ€å¥½ä½¿ç”¨æ–°ç”µæ± ) æ‰èƒ½æ»¡è¶³ESP32ä¸»æ§æ¿ï¼Œ2ä¸ªèˆµæœºå’Œé£æ‰‡æ¨¡å—çš„å·¥ä½œç”µåŠ›éœ€æ±‚ï¼Œå¦‚æœè¾¾ä¸åˆ°å®ƒä»¬çš„å·¥ä½œç”µåŠ›éœ€æ±‚ï¼ŒESP32æ¿å°†ä¼šä¸€ç›´å¤ä½å¯¼è‡´ä»£ç æ— æ³•æ­£å¸¸è¿è¡Œï¼›åŒæ—¶ï¼Œæ‰‹æœº/å¹³æ¿çš„APP ä¸Šçš„WiFiä¼šæ–­å¼€ã€‚**

![](media/CVBGww12.jpg)

âš ï¸ **<span style="color: rgb(255, 76, 65);">ç‰¹åˆ«æé†’ï¼š</span> å¦‚æœå•å‡»æŒ‰é’®![](media/1305.png)ï¼ŒShellçª—å£ä¸­æ‰“å°WiFiè¿æ¥ä¸æˆåŠŸç­‰æŠ¥é”™ä¿¡æ¯æ—¶ (å¦‚ä¸‹å›¾æ‰€ç¤º)ï¼Œè¯·æŒ‰ä¸€ä¸‹ESP32ä¸»æ§æ¿ä¸Šçš„å¤ä½é”®é‡å¯ï¼Œé‡æ–°è¿æ¥WiFiï¼Œå¹¶ä¸”ç¡®ä¿ç¤ºä¾‹ä»£ç ä¸­çš„WiFiåç§°ä¸WiFiå¯†ç å’Œæ‰‹æœº/å¹³æ¿ã€æ™ºèƒ½å®¶å±…æ˜¯åŒä¸€ä¸ªWiFiåç§°ä¸å¯†ç ï¼Œç„¶åå†æ¬¡å•å‡»æŒ‰é’®![](media/1305.png) è¿è¡Œç¤ºä¾‹ä»£ç ã€‚**

![](media/img35.png)

![](media/WAXSD11.png)

å•å‡»![](media/1311.png)â€œåœæ­¢/å¯åŠ¨åç«¯è¿›ç¨‹â€é€€å‡ºç¨‹åºã€‚
